!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o=r(1);class n{static setup(){n.peerConnStack=new Array(0),n.activeConn=0,void 0!==window.Peer&&(n.peerjs=window.Peer),o.KikuAudioStream.setup(),o.KikuAudioStream.listenForStart(n.onStartRecording)}static connectToServer(e,t,r,o,i){n.myname=e,n.serverAddr=t,n.serverPort=r,n.serverPath=o,void 0===i&&(i=!1);let a={host:n.serverAddr,port:n.serverPort,path:n.serverPath,secure:i};n.peer=new n.peerjs(n.myname,a),n.peer.on("connection",e=>{n.onConnectionCallback(e),e.on("data",t=>{n.onDataCallback(e,t)})})}static connectToDevice(e){let t=n.peer.connect(e);t.on("open",()=>{t.on("data",e=>{n.onDataCallback(t,e)})}),n.peerConnStack.push(t)}static sendEmptyResponse(e){let t=n.findIndexOfDevice(e);if(-1!==t){let e=new a(c.REQUEST_EMPTY_RESPONSE);n.peerConnStack[t].open?(n.ourNetworkTime=n.currentTime(),i.sendData(n.peerConnStack[t],e)):console.warn("Connection to peer was not open to send the data via!")}else console.warn("No peer with that ID was found in the active connection stack!")}static async startRecording(e,t,r){void 0!==r&&(n.flightAllowanceTime=r),n.currentMaster=!0,n.inRecordingFlight=!0,n.activeConn=n.findIndexOfDevice(e);let s=performance.timeOrigin+performance.now()+t,d=n.findIndexOfDevice(e);if(-1!==d){let e=new a(c.REQUEST_RECORD,s);console.log("Sending start record message",e),n.peerConnStack[d].open?i.sendData(n.peerConnStack[d],e):console.warn("Connection to peer was not open to send the data via!")}else console.warn("No peer with that ID was found in the active connection stack!");let u=await o.KikuAudioStream.recordAt(s,n.recordDuration);return n.ourBuffer=u,n.currentMaster=!1,new Promise((e,t)=>{setTimeout(()=>{if(n.inRecordingFlight)t("Recording was still in flight and was not transfered back to this device in time");else{let t={currentDeviceBuffer:n.ourBuffer,requestedDeviceBuffer:n.theirBuffer,recordingDelay:n.recordingDelayTime,networkDelay:n.networkDelayTime};e(t)}},n.flightAllowanceTime)})}static sendRecordedBuffer(e,t){let r=n.findIndexOfDevice(e);if(-1!==r){let e=new a(c.RESPONSE_RECORD,n.currentTime(),t);n.peerConnStack[r].open?i.sendData(n.peerConnStack[r],e):console.warn("Connection to peer was not open to send the data via!")}else console.warn("No peer with that ID was found in the active connection stack!")}static onStartRecording(){if(!0!==n.currentMaster){console.log("onStartRecording entering send message");let e=new a(c.STARTED_RECORDING);n.peerConnStack[n.activeConn].open?(n.ourRecordingStart=n.currentTime(),console.log("Sending message of start recording",e),i.sendData(n.peerConnStack[n.activeConn],e)):console.warn("Connection to peer was not open to send the data via!")}}static setReturnAllowance(e){n.flightAllowanceTime=e}static deleteUnusedConnections(){for(let e=0;e<n.peerConnStack.length;e++)n.peerConnStack[e].open||n.peerConnStack.splice(e,1)}static findIndexOfDevice(e){for(var t=0;t<n.peerConnStack.length;t++)if(n.peerConnStack[t].peer===e)return t;return-1}static onDataCallback(e,t){switch(console.log("message received:",t),t.type){case c.REQUEST_EMPTY_RESPONSE:let r=new a(c.RESPONSE_EMPTY_RESPONSE);n.ourNetworkTime=n.currentTime(),i.sendData(e,r);break;case c.REQUEST_RECORD:console.log("Asked to start recording..."),o.KikuAudioStream.recordAt(t.timeStamp,n.recordDuration).then(t=>{console.log("Successfully completed recording!"),this.sendRecordedBuffer(e.peer,t)});break;case c.STARTED_RECORDING:console.log("Started recording message received, updating recording offset..."),n.theirRecordingStart=n.currentTime(),n.updateRecordingDelayTime();break;case c.RESPONSE_EMPTY_RESPONSE:n.theirNetworkTime=n.currentTime(),n.updateNetworkDelayTime();break;case c.RESPONSE_RECORD:n.theirBuffer=t.audioBuffer,n.inRecordingFlight=!1}}static onConnectionCallback(e){console.log("Connection received!",e),n.peerConnStack.push(e)}static onOpenCallback(){console.log("Connection open!")}static currentTime(){return performance.timing.navigationStart+performance.now()}static updateNetworkDelayTime(){n.ourNetworkTime=n.ourNetworkTime||performance.now(),n.theirNetworkTime=n.theirNetworkTime||n.ourNetworkTime,n.networkDelayTime=Math.abs(n.ourNetworkTime-n.theirNetworkTime)/2}static updateRecordingDelayTime(){n.recordingDelayTime=Math.abs(n.ourRecordingStart-n.theirRecordingStart)/2e3,console.log("Recording offset updated to: "+n.recordingDelayTime)}}n.activeConn=0,n.flightAllowanceTime=1e3,n.networkDelayTime=10,n.recordingDelayTime=0,n.ourRecordingStart=n.currentTime(),n.theirRecordingStart=n.ourRecordingStart,n.recordDuration=1e3,n.buffersReady=!1,n.ourBuffer=new Float32Array(1),n.theirBuffer=new Float32Array(1),n.inRecordingFlight=!1,n.currentMaster=!1;class i{static sendData(e,t){let r={type:t.type,timeStamp:t.timeStamp||"",audioBuffer:t.audioBuffer||""};e._open?e.send(r):console.warn("Tried to send message when connection is closed!",r)}}class a{constructor(e,t,r){this.type=e,this.timeStamp=t,this.audioBuffer=r}toObject(){return{messageType:this.type,timeStamp:this.timeStamp||[],audioBuffer:this.audioBuffer||[]}}}var c;!function(e){e.REQUEST_RECORD="requestRecord",e.RESPONSE_RECORD="responseRecord",e.STARTED_RECORDING="startedRecording",e.STOPPED_RECORDING="stoppedRecording",e.REQUEST_EMPTY_RESPONSE="requestEmptyResponse",e.RESPONSE_EMPTY_RESPONSE="responseEmptyResponse"}(c||(c={})),window.Kiku=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class o{static setup(){o.audioContext=new AudioContext||window.webkitAudioContext(),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(console.log("getUserMedia supported."),navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then(function(e){o.setupStream(e)}).catch(function(e){console.warn("The following getUserMedia error occured: "+e)})):console.warn("getUserMedia not supported on your browser!")}static listenForStart(e){this.startedRecording=e}static listenForEnd(e){this.finishedRecording=e}static float32bufferConcat(e,t){let r=e.length,o=new Float32Array(r+t.length);return o.set(e),o.set(t,r),o}static setupStream(e){o.supported=!0,this.micRecorder=new MediaRecorder(e),o.scriptNode=o.audioContext.createScriptProcessor(1024,1,1),o.mediaStreamSourceNode=o.audioContext.createMediaStreamSource(e),o.scriptNode.onaudioprocess=function(e){o.isRecording?o.activeBuffer=o.float32bufferConcat(o.activeBuffer,e.inputBuffer.getChannelData(0)):!0===o.resetAudioBuffer&&(o.activeBuffer=new Float32Array(1),o.resetAudioBuffer=!1)},o.mediaStreamSourceNode.connect(o.scriptNode),o.scriptNode.connect(o.audioContext.destination)}static async recordAt(e,t){o.clearAudioBuffer();let r=e-o.currentTime();console.log("Starting to record in "+r+" from now ("+r/1e3+")");return await(()=>new Promise(e=>{setTimeout(()=>{o.record(t).then(t=>{e(t)})},r)}))()}static record(e){return new Promise(t=>{o.isRecording=!0,o.startedRecording(),setTimeout(()=>{o.isRecording=!1,o.recordedBuffer=o.activeBuffer,t(o.recordedBuffer)},e)})}static recording(){return o.isRecording}static getLastRecordedBuffer(){return o.recordedBuffer}static currentTime(){return performance.timing.navigationStart+performance.now()}static clearAudioBuffer(){o.resetAudioBuffer=!0}}o.isRecording=!1,o.activeBuffer=new Float32Array(1),o.recordedBuffer=new Float32Array(1),o.startedRecording=(()=>{}),o.finishedRecording=(()=>{}),o.audioContext=new AudioContext,o.supported=!1,o.resetAudioBuffer=!1,t.KikuAudioStream=o}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vd2VicGFjay9ib290c3RyYXAiLCJ3ZWJwYWNrOi8vLy4vc3JjL2tpa3UudHMiLCJ3ZWJwYWNrOi8vLy4vc3JjL2tpa3VhdWRpb3N0cmVhbS50cyJdLCJuYW1lcyI6WyJpbnN0YWxsZWRNb2R1bGVzIiwiX193ZWJwYWNrX3JlcXVpcmVfXyIsIm1vZHVsZUlkIiwiZXhwb3J0cyIsIm1vZHVsZSIsImkiLCJsIiwibW9kdWxlcyIsImNhbGwiLCJtIiwiYyIsImQiLCJuYW1lIiwiZ2V0dGVyIiwibyIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImdldCIsInIiLCJTeW1ib2wiLCJ0b1N0cmluZ1RhZyIsInZhbHVlIiwidCIsIm1vZGUiLCJfX2VzTW9kdWxlIiwibnMiLCJjcmVhdGUiLCJrZXkiLCJiaW5kIiwibiIsIm9iamVjdCIsInByb3BlcnR5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJwIiwicyIsImtpa3VhdWRpb3N0cmVhbV8xIiwiS2lrdSIsIltvYmplY3QgT2JqZWN0XSIsInBlZXJDb25uU3RhY2siLCJBcnJheSIsImFjdGl2ZUNvbm4iLCJ1bmRlZmluZWQiLCJ3aW5kb3ciLCJQZWVyIiwicGVlcmpzIiwiS2lrdUF1ZGlvU3RyZWFtIiwic2V0dXAiLCJsaXN0ZW5Gb3JTdGFydCIsIm9uU3RhcnRSZWNvcmRpbmciLCJzZXJ2ZXJBZGRyIiwic2VydmVyUG9ydCIsInNlcnZlclBhdGgiLCJzZWN1cmUiLCJteW5hbWUiLCJzZXJ2ZXJJbmZvIiwiaG9zdCIsInBvcnQiLCJwYXRoIiwicGVlciIsIm9uIiwiY29ubiIsIm9uQ29ubmVjdGlvbkNhbGxiYWNrIiwibWVzc2FnZSIsIm9uRGF0YUNhbGxiYWNrIiwiZGV2aWNlTmFtZSIsInBlZXJDb25uIiwiY29ubmVjdCIsInB1c2giLCJzdGFja0luZGV4IiwiZmluZEluZGV4T2ZEZXZpY2UiLCJNZXNzYWdlRGF0YSIsIk1lc3NhZ2VUeXBlIiwiUkVRVUVTVF9FTVBUWV9SRVNQT05TRSIsIm9wZW4iLCJvdXJOZXR3b3JrVGltZSIsImN1cnJlbnRUaW1lIiwiUGVlckNvbm5lY3Rpb24iLCJzZW5kRGF0YSIsImNvbnNvbGUiLCJ3YXJuIiwiZnJvbU5vdyIsImFsbG93YW5jZVRpbWUiLCJmbGlnaHRBbGxvd2FuY2VUaW1lIiwiY3VycmVudE1hc3RlciIsImluUmVjb3JkaW5nRmxpZ2h0IiwidGltZVN0YW1wIiwicGVyZm9ybWFuY2UiLCJ0aW1lT3JpZ2luIiwibm93IiwiUkVRVUVTVF9SRUNPUkQiLCJsb2ciLCJidWZmZXIiLCJyZWNvcmRBdCIsInJlY29yZER1cmF0aW9uIiwib3VyQnVmZmVyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJzZXRUaW1lb3V0IiwicmVzdWx0cyIsImN1cnJlbnREZXZpY2VCdWZmZXIiLCJyZXF1ZXN0ZWREZXZpY2VCdWZmZXIiLCJ0aGVpckJ1ZmZlciIsInJlY29yZGluZ0RlbGF5IiwicmVjb3JkaW5nRGVsYXlUaW1lIiwibmV0d29ya0RlbGF5IiwibmV0d29ya0RlbGF5VGltZSIsIlJFU1BPTlNFX1JFQ09SRCIsIlNUQVJURURfUkVDT1JESU5HIiwib3VyUmVjb3JkaW5nU3RhcnQiLCJhbGxvd2FuY2UiLCJpbmRleCIsImxlbmd0aCIsInNwbGljZSIsInR5cGUiLCJlbXB0eVJlc3BvbnNlIiwiUkVTUE9OU0VfRU1QVFlfUkVTUE9OU0UiLCJ0aGVuIiwidGhpcyIsInNlbmRSZWNvcmRlZEJ1ZmZlciIsInRoZWlyUmVjb3JkaW5nU3RhcnQiLCJ1cGRhdGVSZWNvcmRpbmdEZWxheVRpbWUiLCJ0aGVpck5ldHdvcmtUaW1lIiwidXBkYXRlTmV0d29ya0RlbGF5VGltZSIsImF1ZGlvQnVmZmVyIiwidGltaW5nIiwibmF2aWdhdGlvblN0YXJ0IiwiTWF0aCIsImFicyIsImJ1ZmZlcnNSZWFkeSIsIkZsb2F0MzJBcnJheSIsIm1lc3NhZ2VEYXRhIiwiX29wZW4iLCJzZW5kIiwibWVzc2FnZVR5cGUiLCJhdWRpb0NvbnRleHQiLCJBdWRpb0NvbnRleHQiLCJ3ZWJraXRBdWRpb0NvbnRleHQiLCJuYXZpZ2F0b3IiLCJtZWRpYURldmljZXMiLCJnZXRVc2VyTWVkaWEiLCJhdWRpbyIsIm1hbmRhdG9yeSIsImdvb2dFY2hvQ2FuY2VsbGF0aW9uIiwiZ29vZ0F1dG9HYWluQ29udHJvbCIsImdvb2dOb2lzZVN1cHByZXNzaW9uIiwiZ29vZ0hpZ2hwYXNzRmlsdGVyIiwib3B0aW9uYWwiLCJzdHJlYW0iLCJzZXR1cFN0cmVhbSIsImNhdGNoIiwiZXJyIiwiY2FsbGJhY2siLCJzdGFydGVkUmVjb3JkaW5nIiwiZmluaXNoZWRSZWNvcmRpbmciLCJidWZmZXIwIiwiYnVmZmVyMSIsIml0ZW0wTGVuZ3RoIiwicmVzdWx0Iiwic2V0Iiwic3VwcG9ydGVkIiwibWljUmVjb3JkZXIiLCJNZWRpYVJlY29yZGVyIiwic2NyaXB0Tm9kZSIsImNyZWF0ZVNjcmlwdFByb2Nlc3NvciIsIm1lZGlhU3RyZWFtU291cmNlTm9kZSIsImNyZWF0ZU1lZGlhU3RyZWFtU291cmNlIiwib25hdWRpb3Byb2Nlc3MiLCJldmVudCIsImlzUmVjb3JkaW5nIiwiYWN0aXZlQnVmZmVyIiwiZmxvYXQzMmJ1ZmZlckNvbmNhdCIsImlucHV0QnVmZmVyIiwiZ2V0Q2hhbm5lbERhdGEiLCJyZXNldEF1ZGlvQnVmZmVyIiwiZGVzdGluYXRpb24iLCJ0aW1lIiwiZHVyYXRpb24iLCJjbGVhckF1ZGlvQnVmZmVyIiwiZXRhX21zIiwicmVjb3JkIiwicmVjb3JkaW5nIiwid2FpdFVudGlsIiwicmVjb3JkZWRCdWZmZXIiXSwibWFwcGluZ3MiOiJhQUNBLElBQUFBLEVBQUEsR0FHQSxTQUFBQyxFQUFBQyxHQUdBLEdBQUFGLEVBQUFFLEdBQ0EsT0FBQUYsRUFBQUUsR0FBQUMsUUFHQSxJQUFBQyxFQUFBSixFQUFBRSxHQUFBLENBQ0FHLEVBQUFILEVBQ0FJLEdBQUEsRUFDQUgsUUFBQSxJQVVBLE9BTkFJLEVBQUFMLEdBQUFNLEtBQUFKLEVBQUFELFFBQUFDLElBQUFELFFBQUFG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LEVBQVNILEVBQU9uSSxFQUFnQjhCLGNBQ3BDRyxRQUFRWSxJQUFJLHlCQUEyQnlGLEVBQVMsY0FBZ0JBLEVBQU8sSUFBTyxLQWlCOUUsWUFkZ0IsS0FDTCxJQUFJcEYsUUFBVUMsSUFDakJFLFdBQVcsS0FDUHJELEVBQWdCdUksT0FBT0gsR0FBVTVELEtBQU1nRSxJQUNuQ3JGLEVBQVFxRixNQUViRixLQUtXRyxHQWFuQmpKLGNBQWU0SSxHQUVsQixPQUFPLElBQUlsRixRQUFVQyxJQUdqQm5ELEVBQWdCNEgsYUFBYyxFQUc5QjVILEVBQWdCNEcsbUJBR2hCdkQsV0FBVyxLQUNQckQsRUFBZ0I0SCxhQUFjLEVBQzlCNUgsRUFBZ0IwSSxlQUFpQjFJLEVBQWdCNkgsYUFDakQxRSxFQUFRbkQsRUFBZ0IwSSxpQkFDekJOLEtBVUo1SSxtQkFDSCxPQUFPUSxFQUFnQjRILFlBUXBCcEksK0JBQ0gsT0FBT1EsRUFBZ0IwSSxlQVFuQmxKLHFCQUNKLE9BQU9pRCxZQUFZdUMsT0FBT0MsZ0JBQWtCeEMsWUFBWUUsTUFHckRuRCwwQkFDSFEsRUFBZ0JpSSxrQkFBbUIsR0FuT2hDakksRUFBQTRILGFBQXVCLEVBQ3ZCNUgsRUFBQTZILGFBQTZCLElBQUl4QyxhQUFhLEdBQzlDckYsRUFBQTBJLGVBQStCLElBQUlyRCxhQUFhLEdBRXpDckYsRUFBQTRHLGlCQUE2QixTQUM3QjVHLEVBQUE2RyxrQkFBOEIsU0FFckM3RyxFQUFBMEYsYUFBNkIsSUFBSUMsYUFNakMzRixFQUFBbUgsV0FBcUIsRUFFYm5ILEVBQUFpSSxrQkFBNEIsRUFqQi9DN0ssRUFBQTRDIiwiZmlsZSI6ImxpYmtpa3UubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiIFx0Ly8gVGhlIG1vZHVsZSBjYWNoZVxuIFx0dmFyIGluc3RhbGxlZE1vZHVsZXMgPSB7fTtcblxuIFx0Ly8gVGhlIHJlcXVpcmUgZnVuY3Rpb25cbiBcdGZ1bmN0aW9uIF9fd2VicGFja19yZXF1aXJlX18obW9kdWxlSWQpIHtcblxuIFx0XHQvLyBDaGVjayBpZiBtb2R1bGUgaXMgaW4gY2FjaGVcbiBcdFx0aWYoaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0pIHtcbiBcdFx0XHRyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0cztcbiBcdFx0fVxuIFx0XHQvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKVxuIFx0XHR2YXIgbW9kdWxlID0gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0gPSB7XG4gXHRcdFx0aTogbW9kdWxlSWQsXG4gXHRcdFx0bDogZmFsc2UsXG4gXHRcdFx0ZXhwb3J0czoge31cbiBcdFx0fTtcblxuIFx0XHQvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb25cbiBcdFx0bW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7XG5cbiBcdFx0Ly8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZFxuIFx0XHRtb2R1bGUubCA9IHRydWU7XG5cbiBcdFx0Ly8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGVcbiBcdFx0cmV0dXJuIG1vZHVsZS5leHBvcnRzO1xuIFx0fVxuXG5cbiBcdC8vIGV4cG9zZSB0aGUgbW9kdWxlcyBvYmplY3QgKF9fd2VicGFja19tb2R1bGVzX18pXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLm0gPSBtb2R1bGVzO1xuXG4gXHQvLyBleHBvc2UgdGhlIG1vZHVsZSBjYWNoZVxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5jID0gaW5zdGFsbGVkTW9kdWxlcztcblxuIFx0Ly8gZGVmaW5lIGdldHRlciBmdW5jdGlvbiBmb3IgaGFybW9ueSBleHBvcnRzXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLmQgPSBmdW5jdGlvbihleHBvcnRzLCBuYW1lLCBnZXR0ZXIpIHtcbiBcdFx0aWYoIV9fd2VicGFja19yZXF1aXJlX18ubyhleHBvcnRzLCBuYW1lKSkge1xuIFx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBuYW1lLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZ2V0dGVyIH0pO1xuIFx0XHR9XG4gXHR9O1xuXG4gXHQvLyBkZWZpbmUgX19lc01vZHVsZSBvbiBleHBvcnRzXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLnIgPSBmdW5jdGlvbihleHBvcnRzKSB7XG4gXHRcdGlmKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC50b1N0cmluZ1RhZykge1xuIFx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICdNb2R1bGUnIH0pO1xuIFx0XHR9XG4gXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7XG4gXHR9O1xuXG4gXHQvLyBjcmVhdGUgYSBmYWtlIG5hbWVzcGFjZSBvYmplY3RcbiBcdC8vIG1vZGUgJiAxOiB2YWx1ZSBpcyBhIG1vZHVsZSBpZCwgcmVxdWlyZSBpdFxuIFx0Ly8gbW9kZSAmIDI6IG1lcmdlIGFsbCBwcm9wZXJ0aWVzIG9mIHZhbHVlIGludG8gdGhlIG5zXG4gXHQvLyBtb2RlICYgNDogcmV0dXJuIHZhbHVlIHdoZW4gYWxyZWFkeSBucyBvYmplY3RcbiBcdC8vIG1vZGUgJiA4fDE6IGJlaGF2ZSBsaWtlIHJlcXVpcmVcbiBcdF9fd2VicGFja19yZXF1aXJlX18udCA9IGZ1bmN0aW9uKHZhbHVlLCBtb2RlKSB7XG4gXHRcdGlmKG1vZGUgJiAxKSB2YWx1ZSA9IF9fd2VicGFja19yZXF1aXJlX18odmFsdWUpO1xuIFx0XHRpZihtb2RlICYgOCkgcmV0dXJuIHZhbHVlO1xuIFx0XHRpZigobW9kZSAmIDQpICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgJiYgdmFsdWUuX19lc01vZHVsZSkgcmV0dXJuIHZhbHVlO1xuIFx0XHR2YXIgbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuIFx0XHRfX3dlYnBhY2tfcmVxdWlyZV9fLnIobnMpO1xuIFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkobnMsICdkZWZhdWx0JywgeyBlbnVtZXJhYmxlOiB0cnVlLCB2YWx1ZTogdmFsdWUgfSk7XG4gXHRcdGlmKG1vZGUgJiAyICYmIHR5cGVvZiB2YWx1ZSAhPSAnc3RyaW5nJykgZm9yKHZhciBrZXkgaW4gdmFsdWUpIF9fd2VicGFja19yZXF1aXJlX18uZChucywga2V5LCBmdW5jdGlvbihrZXkpIHsgcmV0dXJuIHZhbHVlW2tleV07IH0uYmluZChudWxsLCBrZXkpKTtcbiBcdFx0cmV0dXJuIG5zO1xuIFx0fTtcblxuIFx0Ly8gZ2V0RGVmYXVsdEV4cG9ydCBmdW5jdGlvbiBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIG5vbi1oYXJtb255IG1vZHVsZXNcbiBcdF9fd2VicGFja19yZXF1aXJlX18ubiA9IGZ1bmN0aW9uKG1vZHVsZSkge1xuIFx0XHR2YXIgZ2V0dGVyID0gbW9kdWxlICYmIG1vZHVsZS5fX2VzTW9kdWxlID9cbiBcdFx0XHRmdW5jdGlvbiBnZXREZWZhdWx0KCkgeyByZXR1cm4gbW9kdWxlWydkZWZhdWx0J107IH0gOlxuIFx0XHRcdGZ1bmN0aW9uIGdldE1vZHVsZUV4cG9ydHMoKSB7IHJldHVybiBtb2R1bGU7IH07XG4gXHRcdF9fd2VicGFja19yZXF1aXJlX18uZChnZXR0ZXIsICdhJywgZ2V0dGVyKTtcbiBcdFx0cmV0dXJuIGdldHRlcjtcbiBcdH07XG5cbiBcdC8vIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbFxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5vID0gZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgeyByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpOyB9O1xuXG4gXHQvLyBfX3dlYnBhY2tfcHVibGljX3BhdGhfX1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5wID0gXCJcIjtcblxuXG4gXHQvLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHNcbiBcdHJldHVybiBfX3dlYnBhY2tfcmVxdWlyZV9fKF9fd2VicGFja19yZXF1aXJlX18ucyA9IDApO1xuIiwiaW1wb3J0IHsgS2lrdUF1ZGlvU3RyZWFtIH0gZnJvbSAnLi9raWt1YXVkaW9zdHJlYW0nO1xuXG4vKipcbiAqIEBjbGFzcyBLaWt1XG4gKi9cbmNsYXNzIEtpa3Uge1xuXG4gICAgc3RhdGljIG15bmFtZT86IHN0cmluZztcbiAgICBzdGF0aWMgc2VydmVyQWRkcj86IHN0cmluZztcbiAgICBzdGF0aWMgc2VydmVyUG9ydD86IHN0cmluZztcbiAgICBzdGF0aWMgc2VydmVyUGF0aD86IHN0cmluZztcbiAgICBzdGF0aWMgcGVlcmpzPzogYW55O1xuICAgIHN0YXRpYyBwZWVyPzogYW55O1xuICAgIHN0YXRpYyBwZWVyQ29ublN0YWNrOiBhbnlbXTtcbiAgICBzdGF0aWMgYWN0aXZlQ29ubjogbnVtYmVyID0gMDtcbiAgICBzdGF0aWMgZmxpZ2h0QWxsb3dhbmNlVGltZTogbnVtYmVyID0gMTAwMDtcblxuICAgIHN0YXRpYyBuZXR3b3JrRGVsYXlUaW1lOiBudW1iZXIgPSAxMDtcbiAgICBzdGF0aWMgb3VyTmV0d29ya1RpbWU/OiBudW1iZXI7IFxuICAgIHN0YXRpYyB0aGVpck5ldHdvcmtUaW1lPzogbnVtYmVyOyBcblxuICAgIHN0YXRpYyByZWNvcmRpbmdEZWxheVRpbWU6IG51bWJlciA9IDA7XG4gICAgc3RhdGljIG91clJlY29yZGluZ1N0YXJ0OiBudW1iZXIgPSBLaWt1LmN1cnJlbnRUaW1lKCk7XG4gICAgc3RhdGljIHRoZWlyUmVjb3JkaW5nU3RhcnQ6IG51bWJlciA9IEtpa3Uub3VyUmVjb3JkaW5nU3RhcnQ7XG5cbiAgICBzdGF0aWMgcmVjb3JkRHVyYXRpb246IG51bWJlciA9IDEwMDA7XG4gICAgc3RhdGljIGJ1ZmZlcnNSZWFkeTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgc3RhdGljIG91ckJ1ZmZlcj86IEZsb2F0MzJBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoMSk7XG4gICAgc3RhdGljIHRoZWlyQnVmZmVyPzogRmxvYXQzMkFycmF5ID0gbmV3IEZsb2F0MzJBcnJheSgxKTtcbiAgICBzdGF0aWMgaW5SZWNvcmRpbmdGbGlnaHQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIHN0YXRpYyBjdXJyZW50TWFzdGVyOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIHNldHVwXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwdWJsaWNcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHNldHVwICgpIHtcblxuICAgICAgICBLaWt1LnBlZXJDb25uU3RhY2sgPSBuZXcgQXJyYXkoMCk7XG4gICAgICAgIEtpa3UuYWN0aXZlQ29ubiA9IDA7XG5cbiAgICAgICAgaWYgKCg8YW55PndpbmRvdykuUGVlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBLaWt1LnBlZXJqcyA9ICg8YW55PndpbmRvdykuUGVlcjtcbiAgICAgICAgfVxuXG4gICAgICAgIEtpa3VBdWRpb1N0cmVhbS5zZXR1cCgpO1xuICAgICAgICBLaWt1QXVkaW9TdHJlYW0ubGlzdGVuRm9yU3RhcnQoS2lrdS5vblN0YXJ0UmVjb3JkaW5nKTtcbiAgICAgICAgXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBjb25uZWN0VG9TZXJ2ZXJcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHB1YmxpY1xuICAgICAqIEBwYXJhbSBuYW1lIDogTmFtZSBvZiB0aGUgcGVlciBvbiB0aGlzIGRldmljZVxuICAgICAqIEBwYXJhbSBzZXJ2ZXJBZGRyIDogU2VydmVyIElQIGxvY2F0aW9uXG4gICAgICogQHBhcmFtIHNlcnZlclBvcnQgOiBTZXJ2ZXIgcG9ydFxuICAgICAqIEBwYXJhbSBzZXJ2ZXJQYXRoIDogUGVlcmpzIHNlcnZlciBwYXRoXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBjb25uZWN0VG9TZXJ2ZXIgKG5hbWU6IHN0cmluZywgc2VydmVyQWRkcjogc3RyaW5nLCBzZXJ2ZXJQb3J0OiBzdHJpbmcsIHNlcnZlclBhdGg6c3RyaW5nLCBzZWN1cmU/OiBib29sZWFuKSB7XG5cbiAgICAgICAgLy8gU2V0dXAgcHJvcGVydGllc1xuICAgICAgICBLaWt1Lm15bmFtZSA9IG5hbWU7XG4gICAgICAgIEtpa3Uuc2VydmVyQWRkciA9IHNlcnZlckFkZHI7XG4gICAgICAgIEtpa3Uuc2VydmVyUG9ydCA9IHNlcnZlclBvcnQ7XG4gICAgICAgIEtpa3Uuc2VydmVyUGF0aCA9IHNlcnZlclBhdGg7XG5cbiAgICAgICAgaWYgKHNlY3VyZSA9PT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgIHNlY3VyZSA9IGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gRm9ybWF0IGZvciBwZWVyanNcbiAgICAgICAgbGV0IHNlcnZlckluZm86IE9iamVjdCA9IHtcbiAgICAgICAgICAgIGhvc3Q6IEtpa3Uuc2VydmVyQWRkcixcbiAgICAgICAgICAgIHBvcnQ6IEtpa3Uuc2VydmVyUG9ydCxcbiAgICAgICAgICAgIHBhdGg6IEtpa3Uuc2VydmVyUGF0aCxcbiAgICAgICAgICAgIHNlY3VyZTogc2VjdXJlXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQ29ubmVjdCB0byBzZXJ2ZXJcbiAgICAgICAgS2lrdS5wZWVyID0gbmV3IEtpa3UucGVlcmpzKEtpa3UubXluYW1lLCBzZXJ2ZXJJbmZvKTsgXG5cbiAgICAgICAgLy8gQXNzaWduIGNhbGxiYWNrcyB0byBwZWVyIG9iamVjdFxuICAgICAgICBLaWt1LnBlZXIub24oJ2Nvbm5lY3Rpb24nLCAoY29ubjogYW55KSA9PiB7XG4gICAgICAgICAgICBLaWt1Lm9uQ29ubmVjdGlvbkNhbGxiYWNrKGNvbm4pO1xuICAgICAgICAgICAgY29ubi5vbignZGF0YScsIChtZXNzYWdlOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBLaWt1Lm9uRGF0YUNhbGxiYWNrKGNvbm4sIG1lc3NhZ2UpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgY29ubmVjdFRvRGV2aWNlXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwdWJsaWNcbiAgICAgKiBAcGFyYW0gZGV2aWNlTmFtZSBcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNvbm5lY3RUb0RldmljZSAoZGV2aWNlTmFtZTogc3RyaW5nKSB7XG5cbiAgICAgICAgLy8gQ29ubmVjdCB0byBwZWVyXG4gICAgICAgIGxldCBwZWVyQ29ubiA9IEtpa3UucGVlci5jb25uZWN0KGRldmljZU5hbWUpO1xuXG4gICAgICAgIC8vIFNldHVwIGNhbGxiYWNrcyBiZWZvcmUgYWRkaW5nIHRvIHRoZSBzdGFja1xuICAgICAgICBwZWVyQ29ubi5vbignb3BlbicsICgpID0+IHtcbiAgICAgICAgICAgIHBlZXJDb25uLm9uKCdkYXRhJywgKG1lc3NhZ2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIEtpa3Uub25EYXRhQ2FsbGJhY2socGVlckNvbm4sIG1lc3NhZ2UpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBBZGQgb250byB0aGUgY29ubmVjdGlvbiBzdGFja1xuICAgICAgICBLaWt1LnBlZXJDb25uU3RhY2sucHVzaChwZWVyQ29ubik7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIHNlbmRFbXB0eVJlc3BvbnNlXG4gICAgICogQHBhcmFtIGRldmljZU5hbWUgOiBOYW1lIG9mIGRldmljZSB0byBzZW5kIG1lc3NhZ2UgdG9cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHNlbmRFbXB0eVJlc3BvbnNlIChkZXZpY2VOYW1lOiBzdHJpbmcpIHtcblxuICAgICAgICBsZXQgc3RhY2tJbmRleCA9IEtpa3UuZmluZEluZGV4T2ZEZXZpY2UoZGV2aWNlTmFtZSk7XG5cbiAgICAgICAgaWYgKHN0YWNrSW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBsZXQgbWVzc2FnZSA9IG5ldyBNZXNzYWdlRGF0YShNZXNzYWdlVHlwZS5SRVFVRVNUX0VNUFRZX1JFU1BPTlNFKTtcbiAgICAgICAgICAgIGlmIChLaWt1LnBlZXJDb25uU3RhY2tbc3RhY2tJbmRleF0ub3Blbil7XG4gICAgICAgICAgICAgICAgS2lrdS5vdXJOZXR3b3JrVGltZSA9IEtpa3UuY3VycmVudFRpbWUoKTtcbiAgICAgICAgICAgICAgICBQZWVyQ29ubmVjdGlvbi5zZW5kRGF0YShLaWt1LnBlZXJDb25uU3RhY2tbc3RhY2tJbmRleF0sIG1lc3NhZ2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0Nvbm5lY3Rpb24gdG8gcGVlciB3YXMgbm90IG9wZW4gdG8gc2VuZCB0aGUgZGF0YSB2aWEhJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ05vIHBlZXIgd2l0aCB0aGF0IElEIHdhcyBmb3VuZCBpbiB0aGUgYWN0aXZlIGNvbm5lY3Rpb24gc3RhY2shJyk7XG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2Qgc3RhcnRSZWNvcmRpbmdcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHB1YmxpY1xuICAgICAqIEBwYXJhbSBkZXZpY2VOYW1lIDogRGV2aWNlIHRvIHJlcXVlc3Qgc3luY2hyb25pemVkIHJlY29yZGluZ1xuICAgICAqIEBwYXJhbSBmcm9tTm93IDogTnVtYmVyIG9mIG1pbGlzZWNvbmRzIHRvIHN0YXJ0IGZyb20gbm93XG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBhc3luYyBzdGFydFJlY29yZGluZyAoZGV2aWNlTmFtZTogc3RyaW5nLCBmcm9tTm93OiBudW1iZXIsIGFsbG93YW5jZVRpbWU/OiBudW1iZXIpIHtcblxuICAgICAgICBpZiAoYWxsb3dhbmNlVGltZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBLaWt1LmZsaWdodEFsbG93YW5jZVRpbWUgPSBhbGxvd2FuY2VUaW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgS2lrdS5jdXJyZW50TWFzdGVyID0gdHJ1ZTtcblxuICAgICAgICBLaWt1LmluUmVjb3JkaW5nRmxpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgS2lrdS5hY3RpdmVDb25uID0gS2lrdS5maW5kSW5kZXhPZkRldmljZShkZXZpY2VOYW1lKTtcblxuICAgICAgICBsZXQgdGltZVN0YW1wID0gcGVyZm9ybWFuY2UudGltZU9yaWdpbiArIHBlcmZvcm1hbmNlLm5vdygpICsgZnJvbU5vdztcblxuICAgICAgICBsZXQgc3RhY2tJbmRleCA9IEtpa3UuZmluZEluZGV4T2ZEZXZpY2UoZGV2aWNlTmFtZSk7XG5cbiAgICAgICAgaWYgKHN0YWNrSW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICBsZXQgbWVzc2FnZSA9IG5ldyBNZXNzYWdlRGF0YShNZXNzYWdlVHlwZS5SRVFVRVNUX1JFQ09SRCwgdGltZVN0YW1wKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTZW5kaW5nIHN0YXJ0IHJlY29yZCBtZXNzYWdlJywgbWVzc2FnZSk7XG4gICAgICAgICAgICBpZiAoS2lrdS5wZWVyQ29ublN0YWNrW3N0YWNrSW5kZXhdLm9wZW4pXG4gICAgICAgICAgICAgICAgUGVlckNvbm5lY3Rpb24uc2VuZERhdGEoS2lrdS5wZWVyQ29ublN0YWNrW3N0YWNrSW5kZXhdLCBtZXNzYWdlKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignQ29ubmVjdGlvbiB0byBwZWVyIHdhcyBub3Qgb3BlbiB0byBzZW5kIHRoZSBkYXRhIHZpYSEnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignTm8gcGVlciB3aXRoIHRoYXQgSUQgd2FzIGZvdW5kIGluIHRoZSBhY3RpdmUgY29ubmVjdGlvbiBzdGFjayEnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBidWZmZXIgPSBhd2FpdCBLaWt1QXVkaW9TdHJlYW0ucmVjb3JkQXQodGltZVN0YW1wLCBLaWt1LnJlY29yZER1cmF0aW9uKTtcbiAgICAgICAgS2lrdS5vdXJCdWZmZXIgPSA8RmxvYXQzMkFycmF5PmJ1ZmZlcjtcbiAgICAgICAgS2lrdS5jdXJyZW50TWFzdGVyID0gZmFsc2U7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlICgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpPT4ge1xuICAgICAgICAgICAgICAgIGlmIChLaWt1LmluUmVjb3JkaW5nRmxpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCgnUmVjb3JkaW5nIHdhcyBzdGlsbCBpbiBmbGlnaHQgYW5kIHdhcyBub3QgdHJhbnNmZXJlZCBiYWNrIHRvIHRoaXMgZGV2aWNlIGluIHRpbWUnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0cyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnREZXZpY2VCdWZmZXI6IEtpa3Uub3VyQnVmZmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdGVkRGV2aWNlQnVmZmVyOiBLaWt1LnRoZWlyQnVmZmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkaW5nRGVsYXk6IEtpa3UucmVjb3JkaW5nRGVsYXlUaW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV0d29ya0RlbGF5OiBLaWt1Lm5ldHdvcmtEZWxheVRpbWVcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSAocmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgS2lrdS5mbGlnaHRBbGxvd2FuY2VUaW1lKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBzZW5kUmVjb3JkZWRCdWZmZXJcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHB1YmxpY1xuICAgICAqIEBwYXJhbSBkZXZpY2VOYW1lIDogRGV2aWNlIHRvIHNlbmQgcmVjb3JkZWQgYnVmZmVyIHRvXG4gICAgICogQHBhcmFtIGJ1ZmZlciA6IEF1ZGlvIGJ1ZmZlciB0byBzZW5kXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBzZW5kUmVjb3JkZWRCdWZmZXIgKGRldmljZU5hbWU6IHN0cmluZywgYnVmZmVyOiBGbG9hdDMyQXJyYXkpIHtcbiAgICAgICAgbGV0IHN0YWNrSW5kZXggPSBLaWt1LmZpbmRJbmRleE9mRGV2aWNlKGRldmljZU5hbWUpO1xuXG4gICAgICAgIGlmIChzdGFja0luZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgbGV0IG1lc3NhZ2UgPSBuZXcgTWVzc2FnZURhdGEoTWVzc2FnZVR5cGUuUkVTUE9OU0VfUkVDT1JELCBLaWt1LmN1cnJlbnRUaW1lKCksIGJ1ZmZlcik7XG4gICAgICAgICAgICBpZiAoS2lrdS5wZWVyQ29ublN0YWNrW3N0YWNrSW5kZXhdLm9wZW4pXG4gICAgICAgICAgICAgICAgUGVlckNvbm5lY3Rpb24uc2VuZERhdGEoS2lrdS5wZWVyQ29ublN0YWNrW3N0YWNrSW5kZXhdLCBtZXNzYWdlKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignQ29ubmVjdGlvbiB0byBwZWVyIHdhcyBub3Qgb3BlbiB0byBzZW5kIHRoZSBkYXRhIHZpYSEnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignTm8gcGVlciB3aXRoIHRoYXQgSUQgd2FzIGZvdW5kIGluIHRoZSBhY3RpdmUgY29ubmVjdGlvbiBzdGFjayEnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2Qgb25TdGFydFJlY29yZGluZ1xuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIG9uU3RhcnRSZWNvcmRpbmcgKCkge1xuICAgICAgICBpZiAoS2lrdS5jdXJyZW50TWFzdGVyICE9PSB0cnVlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnb25TdGFydFJlY29yZGluZyBlbnRlcmluZyBzZW5kIG1lc3NhZ2UnKTtcbiAgICAgICAgICAgIGxldCBtZXNzYWdlID0gbmV3IE1lc3NhZ2VEYXRhKE1lc3NhZ2VUeXBlLlNUQVJURURfUkVDT1JESU5HKTtcbiAgICAgICAgICAgIGlmIChLaWt1LnBlZXJDb25uU3RhY2tbS2lrdS5hY3RpdmVDb25uXS5vcGVuKXtcbiAgICAgICAgICAgICAgICBLaWt1Lm91clJlY29yZGluZ1N0YXJ0ID0gS2lrdS5jdXJyZW50VGltZSgpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTZW5kaW5nIG1lc3NhZ2Ugb2Ygc3RhcnQgcmVjb3JkaW5nJywgbWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgUGVlckNvbm5lY3Rpb24uc2VuZERhdGEoS2lrdS5wZWVyQ29ublN0YWNrW0tpa3UuYWN0aXZlQ29ubl0sIG1lc3NhZ2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ0Nvbm5lY3Rpb24gdG8gcGVlciB3YXMgbm90IG9wZW4gdG8gc2VuZCB0aGUgZGF0YSB2aWEhJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIHNldFJldHVybkFsbG93YW5jZVxuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHVibGljXG4gICAgICogQHBhcmFtIGFsbG93YW5jZSA6IFJldHVybiB0aW1lIGFsbG93YW5jZSBiZWZvcmUgdGltZW91dCB3aGVuIHdhaXRpbmcgZm9yIG90aGVyIGRldmljZSBidWZmZXJcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHNldFJldHVybkFsbG93YW5jZSAoYWxsb3dhbmNlOiBudW1iZXIpIHtcbiAgICAgICAgS2lrdS5mbGlnaHRBbGxvd2FuY2VUaW1lID0gYWxsb3dhbmNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgZGVsZXRlVW51c2VkQ29ubmVjdGlvbnNcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHB1YmxpY1xuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgZGVsZXRlVW51c2VkQ29ubmVjdGlvbnMgKCkge1xuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgS2lrdS5wZWVyQ29ublN0YWNrLmxlbmd0aDsgaW5kZXgrKyl7XG4gICAgICAgICAgICBpZiAoIUtpa3UucGVlckNvbm5TdGFja1tpbmRleF0ub3Blbil7XG4gICAgICAgICAgICAgICAgS2lrdS5wZWVyQ29ublN0YWNrLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIGZpbmRJbmRleE9mRGV2aWNlXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIGRldmljZU5hbWUgOiBEZXZpY2UgaWQgdG8gc2VhcmNoIGluIHRoZSBjb25uZWN0aW9uIHN0YWNrXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgZmluZEluZGV4T2ZEZXZpY2UgKGRldmljZU5hbWU6IHN0cmluZykgOiBudW1iZXIge1xuXG4gICAgICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBLaWt1LnBlZXJDb25uU3RhY2subGVuZ3RoOyBpbmRleCsrKXtcbiAgICAgICAgICAgIGlmIChLaWt1LnBlZXJDb25uU3RhY2tbaW5kZXhdLnBlZXIgPT09IGRldmljZU5hbWUpeyAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiBpbmRleDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gLTE7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBvbkRhdGFDYWxsYmFja1xuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqIEBwYXJhbSBjb25uIDogUGVlcmpzIGNvbm5lY3Rpb24gdG8gcGFzcyBpblxuICAgICAqIEBwYXJhbSBtZXNzYWdlIDogTWVzc2FnZSByZWNlaXZlZCBvbiB0aGUgY29ubmVjdGlvblxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIG9uRGF0YUNhbGxiYWNrIChjb25uOiBhbnksIG1lc3NhZ2U6IGFueSkge1xuXG4gICAgICAgIGNvbnNvbGUubG9nKCdtZXNzYWdlIHJlY2VpdmVkOicsIG1lc3NhZ2UpO1xuXG4gICAgICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7XG5cbiAgICAgICAgICAgIGNhc2UgKE1lc3NhZ2VUeXBlLlJFUVVFU1RfRU1QVFlfUkVTUE9OU0UpOlxuICAgICAgICAgICAgICAgIGxldCBlbXB0eVJlc3BvbnNlID0gbmV3IE1lc3NhZ2VEYXRhKE1lc3NhZ2VUeXBlLlJFU1BPTlNFX0VNUFRZX1JFU1BPTlNFKTtcbiAgICAgICAgICAgICAgICBLaWt1Lm91ck5ldHdvcmtUaW1lID0gS2lrdS5jdXJyZW50VGltZSgpO1xuICAgICAgICAgICAgICAgIFBlZXJDb25uZWN0aW9uLnNlbmREYXRhKGNvbm4sIGVtcHR5UmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIChNZXNzYWdlVHlwZS5SRVFVRVNUX1JFQ09SRCk6XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0Fza2VkIHRvIHN0YXJ0IHJlY29yZGluZy4uLicpXG4gICAgICAgICAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLnJlY29yZEF0KG1lc3NhZ2UudGltZVN0YW1wLCBLaWt1LnJlY29yZER1cmF0aW9uKS50aGVuKChidWZmZXI6IGFueSk9PntcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1N1Y2Nlc3NmdWxseSBjb21wbGV0ZWQgcmVjb3JkaW5nIScpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbmRSZWNvcmRlZEJ1ZmZlcihjb25uLnBlZXIsIGJ1ZmZlcik7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSAoTWVzc2FnZVR5cGUuU1RBUlRFRF9SRUNPUkRJTkcpOlxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTdGFydGVkIHJlY29yZGluZyBtZXNzYWdlIHJlY2VpdmVkLCB1cGRhdGluZyByZWNvcmRpbmcgb2Zmc2V0Li4uJyk7XG4gICAgICAgICAgICAgICAgS2lrdS50aGVpclJlY29yZGluZ1N0YXJ0ID0gS2lrdS5jdXJyZW50VGltZSgpO1xuICAgICAgICAgICAgICAgIEtpa3UudXBkYXRlUmVjb3JkaW5nRGVsYXlUaW1lKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgKE1lc3NhZ2VUeXBlLlJFU1BPTlNFX0VNUFRZX1JFU1BPTlNFKTpcbiAgICAgICAgICAgICAgICBLaWt1LnRoZWlyTmV0d29ya1RpbWUgPSBLaWt1LmN1cnJlbnRUaW1lKCk7XG4gICAgICAgICAgICAgICAgS2lrdS51cGRhdGVOZXR3b3JrRGVsYXlUaW1lKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgKE1lc3NhZ2VUeXBlLlJFU1BPTlNFX1JFQ09SRCk6XG4gICAgICAgICAgICAgICAgS2lrdS50aGVpckJ1ZmZlciA9IG1lc3NhZ2UuYXVkaW9CdWZmZXI7XG4gICAgICAgICAgICAgICAgS2lrdS5pblJlY29yZGluZ0ZsaWdodCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIEBtZXRob2Qgb25Db25uZWN0aW9uQ2FsbGJhY2tcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHByaXZhdGVcbiAgICAgKiBAcGFyYW0gY29ubiA6IFBlZXJqcyBjb25uZWN0aW9uXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgb25Db25uZWN0aW9uQ2FsbGJhY2sgKGNvbm46IGFueSkge1xuICAgICAgICBjb25zb2xlLmxvZygnQ29ubmVjdGlvbiByZWNlaXZlZCEnLCBjb25uKTtcbiAgICAgICAgS2lrdS5wZWVyQ29ublN0YWNrLnB1c2goY29ubik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBvbk9wZW5DYWxsYmFja1xuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIG9uT3BlbkNhbGxiYWNrICgpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0Nvbm5lY3Rpb24gb3BlbiEnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIGN1cnJlbnRUaW1lXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgY3VycmVudFRpbWUgKCkgOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gcGVyZm9ybWFuY2UudGltaW5nLm5hdmlnYXRpb25TdGFydCArIHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgdXBkYXRlTmV0d29ya0RlbGF5VGltZVxuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHVwZGF0ZU5ldHdvcmtEZWxheVRpbWUgKCkge1xuICAgICAgICBLaWt1Lm91ck5ldHdvcmtUaW1lID0gS2lrdS5vdXJOZXR3b3JrVGltZSB8fCBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICAgICAgS2lrdS50aGVpck5ldHdvcmtUaW1lID0gS2lrdS50aGVpck5ldHdvcmtUaW1lIHx8IEtpa3Uub3VyTmV0d29ya1RpbWU7XG4gICAgICAgIEtpa3UubmV0d29ya0RlbGF5VGltZSA9IE1hdGguYWJzKEtpa3Uub3VyTmV0d29ya1RpbWUgLSBLaWt1LnRoZWlyTmV0d29ya1RpbWUpLzI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCB1cGRhdGVSZWNvcmRpbmdEZWxheVRpbWVcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyB1cGRhdGVSZWNvcmRpbmdEZWxheVRpbWUgKCkge1xuICAgICAgICBLaWt1LnJlY29yZGluZ0RlbGF5VGltZSA9IE1hdGguYWJzKEtpa3Uub3VyUmVjb3JkaW5nU3RhcnQgLSBLaWt1LnRoZWlyUmVjb3JkaW5nU3RhcnQpLzIwMDA7XG4gICAgICAgIGNvbnNvbGUubG9nKCdSZWNvcmRpbmcgb2Zmc2V0IHVwZGF0ZWQgdG86ICcgKyBLaWt1LnJlY29yZGluZ0RlbGF5VGltZSk7XG4gICAgfVxuXG59XG5cbi8qKlxuICogQGNsYXNzIFBlZXJDb25uZWN0aW9uXG4gKi9cbmNsYXNzIFBlZXJDb25uZWN0aW9uIHtcblxuICAgIC8qKlxuICAgICAqIEBtZXRob2Qgc2VuZERhdGFcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHB1YmxpY1xuICAgICAqIEBwYXJhbSBjb25uIDogUGVlcmpzIGNvbm5lY3Rpb24gb2JqZWN0XG4gICAgICogQHBhcmFtIG1lc3NhZ2VEYXRhIDogTWVzc2FnZURhdGEgb2JqZWN0IHdpdGggZGF0YSB0byBzZW5kXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBzZW5kRGF0YSAoY29ubjogYW55LCBtZXNzYWdlRGF0YTogTWVzc2FnZURhdGEpIHtcblxuICAgICAgICBsZXQgbWVzc2FnZTogT2JqZWN0ID0ge1xuICAgICAgICAgICAgdHlwZTogbWVzc2FnZURhdGEudHlwZSxcbiAgICAgICAgICAgIHRpbWVTdGFtcDogbWVzc2FnZURhdGEudGltZVN0YW1wIHx8ICcnLFxuICAgICAgICAgICAgYXVkaW9CdWZmZXI6IG1lc3NhZ2VEYXRhLmF1ZGlvQnVmZmVyIHx8ICcnXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGNvbm4uX29wZW4pIHtcbiAgICAgICAgICAgIGNvbm4uc2VuZChtZXNzYWdlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignVHJpZWQgdG8gc2VuZCBtZXNzYWdlIHdoZW4gY29ubmVjdGlvbiBpcyBjbG9zZWQhJywgbWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogQGNsYXNzIE1lc3NhZ2VEYXRhXG4gKi9cbmNsYXNzIE1lc3NhZ2VEYXRhIHtcblxuICAgIHR5cGU6IHN0cmluZztcbiAgICB0aW1lU3RhbXA/OiBudW1iZXI7XG4gICAgYXVkaW9CdWZmZXI/OiBGbG9hdDMyQXJyYXk7XG5cbiAgICAvKipcbiAgICAgKiBAY29uc3RydWN0b3JcbiAgICAgKiBAcGFyYW0gbWVzc2FnZVR5cGUgOiBNZXNzYWdlIHR5cGUgdG8gc2VuZCBvZiB0eXBlIGVudW0gTWVzc2FnZVR5cGVcbiAgICAgKiBAcGFyYW0gdGltZVN0YW1wIDogVGltaW5nIGluZm9ybWF0aW9uIHJlbGF0ZWQgdG8gdGhlIG1lc3NhZ2VcbiAgICAgKiBAcGFyYW0gYXVkaW9CdWZmZXIgOiBBdWRpbyBidWZmZXIgdG8gc2VuZFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yIChtZXNzYWdlVHlwZTogc3RyaW5nLCB0aW1lU3RhbXA/OiBudW1iZXIsIGF1ZGlvQnVmZmVyPzogRmxvYXQzMkFycmF5KSB7XG4gICAgICAgIHRoaXMudHlwZSA9IG1lc3NhZ2VUeXBlO1xuICAgICAgICB0aGlzLnRpbWVTdGFtcCA9IHRpbWVTdGFtcDtcbiAgICAgICAgdGhpcy5hdWRpb0J1ZmZlciA9IGF1ZGlvQnVmZmVyO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgdG9PYmplY3RcbiAgICAgKiBAcHVibGljXG4gICAgICovXG4gICAgcHVibGljIHRvT2JqZWN0ICgpIDogT2JqZWN0IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1lc3NhZ2VUeXBlOiB0aGlzLnR5cGUsXG4gICAgICAgICAgICB0aW1lU3RhbXA6IHRoaXMudGltZVN0YW1wIHx8IFtdLFxuICAgICAgICAgICAgYXVkaW9CdWZmZXI6IHRoaXMuYXVkaW9CdWZmZXIgfHwgW11cbiAgICAgICAgfTtcbiAgICB9XG5cbn1cblxuLyoqXG4gKiBAZW51bSBNZXNzYWdlVHlwZVxuICovXG5lbnVtIE1lc3NhZ2VUeXBlIHtcblxuICAgIFJFUVVFU1RfUkVDT1JEID0gJ3JlcXVlc3RSZWNvcmQnLFxuICAgIFJFU1BPTlNFX1JFQ09SRCA9ICdyZXNwb25zZVJlY29yZCcsXG5cbiAgICBTVEFSVEVEX1JFQ09SRElORyA9ICdzdGFydGVkUmVjb3JkaW5nJyxcbiAgICBTVE9QUEVEX1JFQ09SRElORyA9ICdzdG9wcGVkUmVjb3JkaW5nJyxcblxuICAgIFJFUVVFU1RfRU1QVFlfUkVTUE9OU0UgPSAncmVxdWVzdEVtcHR5UmVzcG9uc2UnLFxuICAgIFJFU1BPTlNFX0VNUFRZX1JFU1BPTlNFID0gJ3Jlc3BvbnNlRW1wdHlSZXNwb25zZSdcblxufVxuXG4vLyBBc3NpZ24gdG8gd2luZG93IGZvciBlYXN5IEpTIHN0YXJ0dXBcbig8YW55PndpbmRvdykuS2lrdSA9IEtpa3U7XG4iLCJkZWNsYXJlIHZhciBNZWRpYVJlY29yZGVyOiBhbnk7XG5cbi8qKlxuICogQGNsYXNzIEtpa3VBdWRpb1N0cmVhbVxuICovXG5leHBvcnQgY2xhc3MgS2lrdUF1ZGlvU3RyZWFtIHtcblxuICAgIHN0YXRpYyBpc1JlY29yZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHN0YXRpYyBhY3RpdmVCdWZmZXI6IEZsb2F0MzJBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoMSk7XG4gICAgc3RhdGljIHJlY29yZGVkQnVmZmVyOiBGbG9hdDMyQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KDEpO1xuXG4gICAgcHVibGljIHN0YXRpYyBzdGFydGVkUmVjb3JkaW5nOiBGdW5jdGlvbiA9ICgpID0+IHt9O1xuICAgIHB1YmxpYyBzdGF0aWMgZmluaXNoZWRSZWNvcmRpbmc6IEZ1bmN0aW9uID0gKCkgPT4ge307XG5cbiAgICBzdGF0aWMgYXVkaW9Db250ZXh0OiBBdWRpb0NvbnRleHQgPSBuZXcgQXVkaW9Db250ZXh0KCk7XG4gICAgc3RhdGljIHNjcmlwdE5vZGU/OiBTY3JpcHRQcm9jZXNzb3JOb2RlO1xuICAgIHN0YXRpYyBtZWRpYVN0cmVhbVNvdXJjZU5vZGU/OiBNZWRpYVN0cmVhbUF1ZGlvU291cmNlTm9kZTtcblxuICAgIHN0YXRpYyBtaWNSZWNvcmRlcj86IE1lZGlhU3RyZWFtO1xuXG4gICAgc3RhdGljIHN1cHBvcnRlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVzZXRBdWRpb0J1ZmZlcjogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBzZXR1cFxuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHVibGljXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBzZXR1cCAoKSB7XG5cbiAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLmF1ZGlvQ29udGV4dCA9IG5ldyBBdWRpb0NvbnRleHQoKSB8fCAoPGFueT53aW5kb3cpLndlYmtpdEF1ZGlvQ29udGV4dCgpO1xuXG4gICAgICAgIGlmIChuYXZpZ2F0b3IubWVkaWFEZXZpY2VzICYmIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKSB7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdnZXRVc2VyTWVkaWEgc3VwcG9ydGVkLicpO1xuICAgICAgICAgICAgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEgKFxuICAgICAgICAgICAgICAgPGFueT57XG4gICAgICAgICAgICAgICAgXCJhdWRpb1wiOiB7XG4gICAgICAgICAgICAgICAgICAgIFwibWFuZGF0b3J5XCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZ29vZ0VjaG9DYW5jZWxsYXRpb25cIjogXCJmYWxzZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJnb29nQXV0b0dhaW5Db250cm9sXCI6IFwiZmFsc2VcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiZ29vZ05vaXNlU3VwcHJlc3Npb25cIjogXCJmYWxzZVwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgXCJnb29nSGlnaHBhc3NGaWx0ZXJcIjogXCJmYWxzZVwiXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIFwib3B0aW9uYWxcIjogW11cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICB9KSAvLyBSZXF1ZXN0IHBlcm1pc3Npb25zXG4gICAgICAgICBcbiAgICAgICAgICAgICAgIC8vIFN1Y2Nlc3MgY2FsbGJhY2tcbiAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChzdHJlYW0pIHtcbiAgICAgICAgICAgICAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLnNldHVwU3RyZWFtKHN0cmVhbSk7XG4gICAgICAgICAgICAgICB9KVxuICAgICAgICAgXG4gICAgICAgICAgICAgICAvLyBFcnJvciBjYWxsYmFja1xuICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdUaGUgZm9sbG93aW5nIGdldFVzZXJNZWRpYSBlcnJvciBvY2N1cmVkOiAnICsgZXJyKTtcbiAgICAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgICk7XG4gICAgXG4gICAgICAgICB9IGVsc2UgeyAvLyBNZWRpYSBkZXZpY2VzIHdlcmVuJ3QgYXZhaWxhYmxlXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ2dldFVzZXJNZWRpYSBub3Qgc3VwcG9ydGVkIG9uIHlvdXIgYnJvd3NlciEnKTtcbiAgICAgICAgIH1cblxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBsaXN0ZW5Gb3JTdGFydFxuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHVibGljXG4gICAgICogQHBhcmFtIGNhbGxiYWNrIDogQ2FsbGJhY2sgdG8gY2FsbCBvbiB0aGUgc3RhcnQgb2YgcmVjb3JkaW5nXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBsaXN0ZW5Gb3JTdGFydCAoY2FsbGJhY2s6IEZ1bmN0aW9uKSB7XG4gICAgICAgIHRoaXMuc3RhcnRlZFJlY29yZGluZyA9IGNhbGxiYWNrO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgbGlzdGVuRm9yRW5kXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwdWJsaWNcbiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgOiBDYWxsYmFjayB0byBjYWxsIG9uIHRoZSBlbmQgb2YgcmVjb3JkaW5nXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBsaXN0ZW5Gb3JFbmQgKGNhbGxiYWNrOiBGdW5jdGlvbikge1xuICAgICAgICB0aGlzLmZpbmlzaGVkUmVjb3JkaW5nID0gY2FsbGJhY2s7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBmbG9hdDMyYnVmZmVyQ29uY2F0XG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwcml2YXRlXG4gICAgICogQHBhcmFtIGJ1ZmZlcjAgXG4gICAgICogQHBhcmFtIGJ1ZmZlcjEgXG4gICAgICovXG4gICAgcHJpdmF0ZSBzdGF0aWMgZmxvYXQzMmJ1ZmZlckNvbmNhdCAoYnVmZmVyMDogRmxvYXQzMkFycmF5LCBidWZmZXIxOiBGbG9hdDMyQXJyYXkpIHtcblxuICAgICAgICBsZXQgaXRlbTBMZW5ndGggPSBidWZmZXIwLmxlbmd0aDtcbiAgICAgICAgbGV0IHJlc3VsdCA9IG5ldyBGbG9hdDMyQXJyYXkoaXRlbTBMZW5ndGggKyBidWZmZXIxLmxlbmd0aCk7XG4gICAgXG4gICAgICAgIHJlc3VsdC5zZXQoYnVmZmVyMCk7XG4gICAgICAgIHJlc3VsdC5zZXQoYnVmZmVyMSwgaXRlbTBMZW5ndGgpO1xuICAgIFxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBzZXR1cFN0cmVhbVxuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqIEBwYXJhbSBzdHJlYW0gOiBNZWRpYSBzdHJlYW0gdG8gc2V0dXAgYXVkaW8gcmVjb3JkaW5nIFxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIHNldHVwU3RyZWFtIChzdHJlYW06IE1lZGlhU3RyZWFtKSB7XG5cbiAgICAgICAgLy8gVXBkYXRlIHN0cmVhbSBpbmZvXG4gICAgICAgIEtpa3VBdWRpb1N0cmVhbS5zdXBwb3J0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLm1pY1JlY29yZGVyID0gbmV3IE1lZGlhUmVjb3JkZXIoc3RyZWFtKTtcblxuICAgICAgICAvLyBDcmVhdGUgbGl2ZSBhdWRpbyBjb250ZXh0IHByb2Nlc3NpbmdcbiAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLnNjcmlwdE5vZGUgPSBLaWt1QXVkaW9TdHJlYW0uYXVkaW9Db250ZXh0LmNyZWF0ZVNjcmlwdFByb2Nlc3NvcigxMDI0LCAxLCAxKTtcbiAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLm1lZGlhU3RyZWFtU291cmNlTm9kZSA9IEtpa3VBdWRpb1N0cmVhbS5hdWRpb0NvbnRleHQuY3JlYXRlTWVkaWFTdHJlYW1Tb3VyY2Uoc3RyZWFtKTtcblxuICAgICAgICAvLyBDYWxsYmFjayBmb3Igc2NyaXB0IHByb2Nlc3NvciBmdW5jdGlvblxuICAgICAgICBLaWt1QXVkaW9TdHJlYW0uc2NyaXB0Tm9kZS5vbmF1ZGlvcHJvY2VzcyA9IGZ1bmN0aW9uKGV2ZW50KSB7XG5cbiAgICAgICAgICAgIC8vIEFkZCBvbnRvIHJlY29yZGVkIGRhdGEgd2hlbiBzZXQgdG8gdHJ1ZVxuICAgICAgICAgICAgaWYoS2lrdUF1ZGlvU3RyZWFtLmlzUmVjb3JkaW5nKSB7XG4gICAgICAgICAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLmFjdGl2ZUJ1ZmZlciA9IEtpa3VBdWRpb1N0cmVhbS5mbG9hdDMyYnVmZmVyQ29uY2F0KEtpa3VBdWRpb1N0cmVhbS5hY3RpdmVCdWZmZXIsIGV2ZW50LmlucHV0QnVmZmVyLmdldENoYW5uZWxEYXRhKDApKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKEtpa3VBdWRpb1N0cmVhbS5yZXNldEF1ZGlvQnVmZmVyID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IG1lbW9yeSBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uXG4gICAgICAgICAgICAgICAgICAgIEtpa3VBdWRpb1N0cmVhbS5hY3RpdmVCdWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KDEpO1xuICAgICAgICAgICAgICAgICAgICBLaWt1QXVkaW9TdHJlYW0ucmVzZXRBdWRpb0J1ZmZlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIENvbm5lY3Qgc291cmNlIHRvIHNjcmlwdCBwcm9jZXNzb3JcbiAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLm1lZGlhU3RyZWFtU291cmNlTm9kZS5jb25uZWN0KEtpa3VBdWRpb1N0cmVhbS5zY3JpcHROb2RlKTtcbiAgICAgICAgS2lrdUF1ZGlvU3RyZWFtLnNjcmlwdE5vZGUuY29ubmVjdChLaWt1QXVkaW9TdHJlYW0uYXVkaW9Db250ZXh0LmRlc3RpbmF0aW9uKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgcmVjb3JkQXRcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHB1YmxpY1xuICAgICAqIEBwYXJhbSB0aW1lIDogVGltZSB0byBzdGFydCByZWNvcmRpbmcgYXQgKHVuaXggdGltZSlcbiAgICAgKiBAcGFyYW0gZHVyYXRpb24gOiBEdXJhdGlvbiB0byByZWNvcmQgZm9yIChtcylcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGFzeW5jIHJlY29yZEF0ICh0aW1lOiBudW1iZXIsIGR1cmF0aW9uOiBudW1iZXIpIHtcblxuICAgICAgICAvLyBSZXNldCBidWZmZXIgYmVmb3JlIGF0dGVtcHRpbmcgdG8gcmVjb3JkXG4gICAgICAgIEtpa3VBdWRpb1N0cmVhbS5jbGVhckF1ZGlvQnVmZmVyKCk7XG5cbiAgICAgICAgLy8gRXN0aW1hdGUgZXhlY3V0aW9uIHRpbWVcbiAgICAgICAgbGV0IGV0YV9tcyA9IHRpbWUgLSBLaWt1QXVkaW9TdHJlYW0uY3VycmVudFRpbWUoKTtcbiAgICAgICAgY29uc29sZS5sb2coJ1N0YXJ0aW5nIHRvIHJlY29yZCBpbiAnICsgZXRhX21zICsgJyBmcm9tIG5vdyAoJyArIGV0YV9tcy8xMDAwICsgJyknKTtcblxuICAgICAgICAvLyBEZWNsYXJlIGNhbGxiYWNrIHVudGlsIGV4ZWN1dGlvbiB0aW1lXG4gICAgICAgIGxldCB3YWl0VW50aWwgPSAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UgKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+e1xuICAgICAgICAgICAgICAgICAgICBLaWt1QXVkaW9TdHJlYW0ucmVjb3JkKGR1cmF0aW9uKS50aGVuKChyZWNvcmRpbmcpPT57XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlY29yZGluZyk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfSwgZXRhX21zKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gV2FpdCB1bnRpbCBleGVjdXRpb24gdGltZVxuICAgICAgICBsZXQgcmVjb3JkaW5nID0gYXdhaXQgd2FpdFVudGlsKCk7XG5cbiAgICAgICAgLy8gUmV0dXJuIHJlY29yZGVkIGJ1ZmZlclxuICAgICAgICByZXR1cm4gcmVjb3JkaW5nO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCByZWNvcmRcbiAgICAgKiBAc3RhdGljXG4gICAgICogQHB1YmxpY1xuICAgICAqIEBwYXJhbSBkdXJhdGlvbiA6IExlbmd0aCB0byByZWNvcmQgZm9yIChtcylcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlY29yZCAoZHVyYXRpb246IG51bWJlcikge1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSAoKHJlc29sdmUpID0+IHtcblxuICAgICAgICAgICAgLy8gU2V0IHJlY29yZCBhdG9taWMgYm9vbGVhbiB0cnVlXG4gICAgICAgICAgICBLaWt1QXVkaW9TdHJlYW0uaXNSZWNvcmRpbmcgPSB0cnVlO1xuXG4gICAgICAgICAgICAvLyBOb3RpZnkgbGlzdGVuZXJzXG4gICAgICAgICAgICBLaWt1QXVkaW9TdHJlYW0uc3RhcnRlZFJlY29yZGluZygpO1xuXG4gICAgICAgICAgICAvLyBUaW1lb3V0IHVudGlsIGZpbmlzaFxuICAgICAgICAgICAgc2V0VGltZW91dCgoKT0+e1xuICAgICAgICAgICAgICAgIEtpa3VBdWRpb1N0cmVhbS5pc1JlY29yZGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIEtpa3VBdWRpb1N0cmVhbS5yZWNvcmRlZEJ1ZmZlciA9IEtpa3VBdWRpb1N0cmVhbS5hY3RpdmVCdWZmZXI7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShLaWt1QXVkaW9TdHJlYW0ucmVjb3JkZWRCdWZmZXIpO1xuICAgICAgICAgICAgfSwgZHVyYXRpb24pO1xuXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgcmVjb3JkaW5nXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwdWJsaWNcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIHJlY29yZGluZyAoKSA6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gS2lrdUF1ZGlvU3RyZWFtLmlzUmVjb3JkaW5nO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgZ2V0TGFzdFJlY29yZGVkQnVmZmVyXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwdWJsaWNcbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGdldExhc3RSZWNvcmRlZEJ1ZmZlciAoKSA6IEZsb2F0MzJBcnJheSB7XG4gICAgICAgIHJldHVybiBLaWt1QXVkaW9TdHJlYW0ucmVjb3JkZWRCdWZmZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBjdXJyZW50VGltZVxuICAgICAqIEBzdGF0aWNcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgc3RhdGljIGN1cnJlbnRUaW1lICgpIDogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHBlcmZvcm1hbmNlLnRpbWluZy5uYXZpZ2F0aW9uU3RhcnQgKyBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGNsZWFyQXVkaW9CdWZmZXIgKCkge1xuICAgICAgICBLaWt1QXVkaW9TdHJlYW0ucmVzZXRBdWRpb0J1ZmZlciA9IHRydWU7XG4gICAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==